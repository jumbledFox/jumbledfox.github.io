<html>
    <head>
        <title>Website Name</title>
        <meta content="jumbledFox's Website" property="og:title" />
        <meta content="Hello, I'm jumbledFox! I'm a 16 year old programmer from the UK." property="og:description" />
        <meta content="https://jumbledFox.github.io/images/favicon.png" property="og:image" />
        <meta content="#EF7D57" data-react-helmet="true" name="theme-color" />
        <style>
            html {
                background-color: #000000;
            }
        </style>
        <!-- Twemoji -->
        <script src="https://cdn.jsdelivr.net/npm/twemoji@12.0.0/2/twemoji.min.js" crossorigin="anonymous"></script>     
        <script src="/loadstyle.js"></script>

        <script>

            function loadpage(l) {
                let withlove = true;
                l = l.toLowerCase();
                let pagetorender = l.replace(/\/$/, "");
                let path = window.location.origin + pagetorender + "/index.md";
                // Look for the markdown file
                fetch(path).then(function(response) {

                    if (pagetorender == "/404") {
                        withlove = false;
                    }
                    // Possible responses
                    switch(response.status) {
                        case 200:
                            // Found the file, so render it
                            break;
                        case 404:
                            // Didn't find the file, so render the 404 page
                            withlove = false;
                            pagetorender = "/404";
                            break;
                        default:
                            // Something else happened, so render the error page
                            pagetorender = "/error";
                            withlove = false;
                            break;
                    }

                    // Change the title
                    
                    pathlist = l.replace(/\/$/, "").split("/");
                    document.title = (l == "/") ? "jumbledFox" : titlise(pathlist[pathlist.length - 1]);


                    let pagetorenderExact = window.location.origin + pagetorender + "/index.md";


                    // Set the link bar
                    var linkbar = document.getElementById("linkbar");
                    linkbar.innerHTML = "";
                    for(var i = 0; i < pathlist.length; i++) {
                        var link = document.createElement("a");
                        link.href = (i != 0) ? pathlist.slice(0, i + 1).join("/") : "/";
                        link.innerHTML = titlise((i != 0) ? pathlist[i] : "Home");
                        linkbar.appendChild(link);

                        if(i < pathlist.length - 1) {
                            var separator = document.createElement("span");
                            separator.innerHTML = " / ";
                            linkbar.appendChild(separator);
                        }
                    }

                                       
                    // Set url if not already
                    if(window.location.pathname != l) {
                        window.history.pushState(l, "", l);
                    }

                    // Render the markdown file
                    if(pagetorenderExact != path) {
                        fetch(pagetorenderExact).then(function(response) { renderpage(response);});
                    } else {
                        renderpage(response);
                    }
                });

                function renderpage(response) {
                    const md = new Remarkable({
                        html:true
                    });

                    response.text().then(function(text) {
                        textsplit = text.split("<script");
                        let inh = "";
                        inh = md.render(textsplit[0] + "<div id='footer'> <foxhr>\nMade with " + ((withlove) ? "â¤" : "ğŸ˜–") + " by <a href='/about'>jumbledFox</a> </div>\n");
                        try {
                            for (let i = 1; i < textsplit.length; i++) {
                                inh += "<script" + textsplit[i];
                            }
                        } catch (Exception) {}

                        try {
                            stopLoop();
                        } catch (Exception) {
                            // No loop to stop
                        }

                        // Replace things

                        inh = inh.replace(/<foxhr>/g, "<fieldset class='foxhr'><legend>ğŸ¦ŠğŸ³ï¸â€ğŸŒˆğŸ¦ŠğŸ³ï¸â€ğŸŒˆğŸ¦ŠğŸ³ï¸â€ğŸŒˆğŸ¦ŠğŸ³ï¸â€ğŸŒˆğŸ¦Š</legend></fieldset>");
                        
                        inh = inh.replace(/\!audio[(]/g, )

                        inh = inh.replace(/<r>/g, "<span class='rainbow'>");
                        inh = inh.replace(/<\/r>/g, "</span>");
                        inh = inh.replace(/<m>/g, "<span class='middle'>");
                        inh = inh.replace(/<\/m>/g, "</span>");
                        inh = inh.replace(/<ro><img/g, "<img class='rainbowoutline' ");
                        inh = inh.replace(/<imgrs><img/g, "<img style='width: 100%; height: auto;'")
                        inh = inh.replace(/<imgrsm><img/g, "<img style='width: 20%; height: auto;'")
                        //inh = inh.replace(/<a/g, "<a target='_blank'");

                        setInnerHTML(document.getElementById("main"), inh);
                        
                        twemoji.parse(document.getElementById("main"), { base: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/' });
                        // For every link, if it's not a local link, open in a new tab
                        for(var i = 0; i < document.getElementsByTagName("A").length; i++) {
                            if(!document.getElementsByTagName("A")[i].href.startsWith(location.origin)) {
                                document.getElementsByTagName("A")[i].target = "_blank";
                            }
                        }

                        // For every image
                        let images = document.getElementsByTagName("IMG");
                        for (var i = 0; i < images.length; i++) {
                            // Decode outerHTML to get the src

                            // TODO: This doesnt work with hash fragments and ?'s, but, not to sound dispassionate, I don't really care
                            let imgSrc = (images[i].outerHTML).split("src=\"")[1].split("\"")[0];
                            // If the src is local
                            if (!imgSrc.startsWith("https://") || imgSrc.startsWith("http://")) {
                                if (imgSrc.startsWith("/")) {
                                    // Absolute path
                                    images[i].src = window.location.origin.split("?")[0].split("#")[0] + imgSrc;
                                } else {
                                    // Relative path
                                    images[i].src = window.location.href.split("?")[0].split("#")[0] + "/" + imgSrc;
                                }
                            }
                        }

                        // Setup
                        setup();
                    });
                }

                function titlise(t) { // An AI wrote this function... I hope it works properly
                    return t.replace("-", " ").replace(/\b\w/g, function(l) {
                        return l.toUpperCase();
                    });
                }
            }
            onload = function() {
                // shamelessly stolen from https://github.com/rafgraph/spa-github-pages/blob/v6.0.0/index.html
                (function(l) {
                    if (l.search[1] === '/' ) {
                    var decoded = l.search.slice(1).split('&').map(function(s) { 
                        return s.replace(/~and~/g, '&')
                    }).join('?');
                    window.history.replaceState(null, null,
                        l.pathname.slice(0, -1) + decoded + l.hash
                    );
                    }
                }(window.location));

                loadpage(window.location.pathname);
            }

            window.onpopstate = function(event) {
                loadpage(window.location.pathname);
            }

            // shamelessly stolen from https://stackoverflow.com/questions/2592092/executing-script-elements-inserted-with-innerhtml
            var setInnerHTML = function(elm, html) {
                elm.innerHTML = html;
                Array.from(elm.querySelectorAll("script")).forEach( oldScript => {
                    const newScript = document.createElement("script");
                    Array.from(oldScript.attributes)
                    .forEach( attr => newScript.setAttribute(attr.name, attr.value) );
                    newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                    oldScript.parentNode.replaceChild(newScript, oldScript);
                });
            }
        </script>
    </head>
    <body>
        <!--
        #
        #
        #
        # My god-awful code lies above
        # Please... for your own good
        #
        #
        #
        #
        #
        #
        #
        #
        #
        #
        #
        #

        -->
        <div id="linkbar"></div>
        <div id="main"></div>
    </body>
</html>
